# Secrets é…ç½®
# ARCTICCLOUD_ACCOUNTS ç¤ºä¾‹ user:password
# TG_BOT_TOKEN ç¤ºä¾‹ 123456789:ABC-DEF...
# TG_CHAT_ID ç¤ºä¾‹ 123456789


name: ArcticCloud è‡ªåŠ¨ç»­æœŸ

on:
  schedule:
    - cron: '02 4 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 12:02 è¿è¡Œ
  workflow_dispatch:

jobs:
  renew:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: ç»­æœŸ VPS
        run: |
          cat << 'EOF' > renew.js
          const https = require('https');
          const { URL } = require('url');
          const ACCOUNTS = process.env.ARCTICCLOUD_ACCOUNTS;
          const TG_BOT_TOKEN = process.env.TG_BOT_TOKEN;
          const TG_CHAT_ID = process.env.TG_CHAT_ID;
          const BASE_URL = 'https://vps.polarbear.nyc.mn';
          const agent = new https.Agent({ rejectUnauthorized: false });
          function request(url, options = {}) {
            return new Promise((resolve, reject) => {
              const u = new URL(url);
              const req = https.request(url, {
                method: options.method || 'GET',
                agent: u.hostname === 'vps.polarbear.nyc.mn' ? agent : undefined,
                headers: {
                  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                  'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                  ...options.headers
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve({
                  status: res.statusCode,
                  headers: res.headers,
                  body: data
                }));
              });
              req.on('error', reject);
              if (options.body) req.write(options.body);
              req.end();
            });
          }
          async function sendTelegram(message) {
            if (!TG_BOT_TOKEN || !TG_CHAT_ID) return;
            try {
              await request(`https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: TG_CHAT_ID, text: message, parse_mode: 'Markdown' })
              });
            } catch (e) {}
          }
          function parseAccounts(str) {
            const accounts = [];
            for (const line of str.trim().split('\n')) {
              if (!line.trim()) continue;
              const [username, password] = line.split(':');
              if (username && password) {
                accounts.push({ username: username.trim(), password: password.trim() });
              }
            }
            return accounts;
          }
          function parseVPSList(html) {
            const vpsList = [];
            // åŒ¹é…æ¯ä¸€è¡Œ <tr>...</tr>
            const rowRegex = /<tr>[\s\S]*?<td>[^<]*<\/td>\s*<td>([^<]+)<\/td>[\s\S]*?href="\/control\/detail\/(\d+)\/"[\s\S]*?<\/tr>/g;
            let match;
            while ((match = rowRegex.exec(html)) !== null) {
              vpsList.push({
                name: match[1].trim(),
                id: match[2]
              });
            }
            return vpsList;
          }
          async function renewAccount(account, index) {
            let logResult = `\nğŸ”¹ è´¦å· ${index}\n`;
            let tgResult = `\nğŸ‘¤ *${account.username}*\n`;
            try {
              // ç™»å½•
              const loginResp = await request(`${BASE_URL}/index/login/`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                  'Origin': BASE_URL,
                  'Referer': `${BASE_URL}/index/login/`
                },
                body: `swapname=${encodeURIComponent(account.username)}&swappass=${encodeURIComponent(account.password)}`
              });
              const location = loginResp.headers.location || '';
              const setCookie = loginResp.headers['set-cookie'] || [];
              const cookieStr = Array.isArray(setCookie) ? setCookie.join('; ') : setCookie;
              if (location.includes('error=')) {
                const error = decodeURIComponent(location.match(/error=([^&]+)/)?.[1] || 'æœªçŸ¥');
                logResult += `âŒ ç™»å½•å¤±è´¥: ${error}\n`;
                tgResult += `âŒ ç™»å½•å¤±è´¥: ${error}\n`;
                return { logResult, tgResult };
              }
              const uuidMatch = /swapuuid=([^;]+)/.exec(cookieStr);
              if (!uuidMatch) {
                logResult += `âŒ ç™»å½•å¤±è´¥: æœªè·å–å‡­è¯\n`;
                tgResult += `âŒ ç™»å½•å¤±è´¥: æœªè·å–å‡­è¯\n`;
                return { logResult, tgResult };
              }
              const cookie = `swapuuid=${uuidMatch[1]}`;
              logResult += `âœ… ç™»å½•æˆåŠŸ\n`;
              tgResult += `âœ… ç™»å½•æˆåŠŸ\n`;
              // è·å– VPS åˆ—è¡¨
              const listResp = await request(`${BASE_URL}/control/index/`, {
                headers: { 'Cookie': cookie }
              });
              const vpsList = parseVPSList(listResp.body);
              
              if (vpsList.length === 0) {
                logResult += `  âš ï¸ æœªæ‰¾åˆ° VPS\n`;
                tgResult += `  âš ï¸ æœªæ‰¾åˆ° VPS\n`;
                return { logResult, tgResult };
              }
              logResult += `  ğŸ“¦ æ‰¾åˆ° ${vpsList.length} ä¸ª VPS\n`;
              tgResult += `  ğŸ“¦ æ‰¾åˆ° ${vpsList.length} ä¸ª VPS\n`;
              // ç»­æœŸæ¯ä¸ª VPS
              for (const vps of vpsList) {
                const renewResp = await request(`${BASE_URL}/control/detail/${vps.id}/pay/`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Cookie': cookie,
                    'Origin': BASE_URL,
                    'Referer': `${BASE_URL}/control/detail/${vps.id}/`
                  }
                });
                const renewLocation = renewResp.headers.location || '';
                const successMatch = renewLocation.match(/success=([^&]+)/);
                const errorMatch = renewLocation.match(/error=([^&]+)/);
                let result;
                if (successMatch) {
                  result = `âœ… ${vps.name}: ${decodeURIComponent(successMatch[1])}`;
                } else if (errorMatch) {
                  result = `âŒ ${vps.name}: ${decodeURIComponent(errorMatch[1])}`;
                } else {
                  result = `â“ ${vps.name}: çŠ¶æ€ç  ${renewResp.status}`;
                }
                logResult += `  ${result}\n`;
                tgResult += `  ${result}\n`;
              }
            } catch (err) {
              logResult += `âŒ å¼‚å¸¸: ${err.message}\n`;
              tgResult += `âŒ å¼‚å¸¸: ${err.message}\n`;
            }
            return { logResult, tgResult };
          }
          async function main() {
            const timeStr = new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'});
            
            if (!ACCOUNTS) {
              console.log('âŒ ARCTICCLOUD_ACCOUNTS æœªè®¾ç½®');
              await sendTelegram(`ğŸ» *ArcticCloud VPS ç»­æœŸ*\nğŸ•’ ${timeStr}\n\nâŒ ARCTICCLOUD_ACCOUNTS æœªè®¾ç½®`);
              return;
            }
            const accounts = parseAccounts(ACCOUNTS);
            if (accounts.length === 0) {
              console.log('âŒ ARCTICCLOUD_ACCOUNTS æ ¼å¼é”™è¯¯');
              await sendTelegram(`ğŸ» *ArcticCloud VPS ç»­æœŸ*\nğŸ•’ ${timeStr}\n\nâŒ ARCTICCLOUD_ACCOUNTS æ ¼å¼é”™è¯¯`);
              return;
            }
            let logMsg = `ğŸ» ArcticCloud VPS ç»­æœŸ\nğŸ•’ ${timeStr}\nğŸ“Š å…± ${accounts.length} ä¸ªè´¦å·\n`;
            let tgMsg = `ğŸ» *ArcticCloud VPS ç»­æœŸ*\nğŸ•’ ${timeStr}\n\nğŸ“Š å…± ${accounts.length} ä¸ªè´¦å·\n`;
            for (let i = 0; i < accounts.length; i++) {
              const { logResult, tgResult } = await renewAccount(accounts[i], i + 1);
              logMsg += logResult;
              tgMsg += tgResult;
            }
            logMsg += '\nâœ… ä»»åŠ¡å®Œæˆ';
            tgMsg += '\nâœ… ä»»åŠ¡å®Œæˆ';
            console.log(logMsg);
            await sendTelegram(tgMsg);
          }
          main();
          EOF
          node renew.js
        env:
          ARCTICCLOUD_ACCOUNTS: ${{ secrets.ARCTICCLOUD_ACCOUNTS }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

      - name: æ¸…ç†å·¥ä½œæµè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          delete_workflow_pattern: ${{ github.workflow }}
          retain_days: 0
          keep_minimum_runs: 3
